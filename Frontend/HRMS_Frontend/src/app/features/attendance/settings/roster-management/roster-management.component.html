<div class="grid grid-cols-1 gap-6">
    <p-toast></p-toast>
    
    <!-- Bulk Initialize -->
    <div class="card bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-100 dark:border-zinc-800 p-6">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="pi pi-calendar-plus text-blue-600"></i>
            إنشاء جدول مناوبات (Bulk)
        </h3>
        
        <form [formGroup]="initForm" (ngSubmit)="onInitialize()" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="field">
                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">من تاريخ</label>
                    <p-datepicker formControlName="startDate" [showIcon]="true" styleClass="w-full"></p-datepicker>
                </div>
                <div class="field">
                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">إلى تاريخ</label>
                    <p-datepicker formControlName="endDate" [showIcon]="true" styleClass="w-full"></p-datepicker>
                </div>
                <div class="field">
                     <label class="block text-sm font-medium mb-1 dark:text-gray-300">المناوبة الافتراضية</label>
                     <p-select [options]="shifts()" formControlName="shiftId" optionLabel="shiftNameAr" optionValue="shiftId" placeholder="اختر المناوبة" styleClass="w-full"></p-select>
                </div>
                <div class="field">
                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">الموظف (اختياري)</label>
                    <p-select [options]="employees()" formControlName="employeeId" optionLabel="fullName" optionValue="id" [showClear]="true" placeholder="الكل (اختياري)" styleClass="w-full"></p-select>
                </div>
            </div>
            <button pButton type="submit" label="إنشاء الجدول" icon="pi pi-check" [disabled]="initForm.invalid" class="w-full md:w-auto"></button>
        </form>
    </div>

    <!-- Manual Assignment Editor -->
    <div class="card bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-100 dark:border-zinc-800 p-6">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="pi pi-user-edit text-purple-600"></i>
            تخصيص يدوي / تعديل
        </h3>
        
        <div class="flex items-center gap-4 mb-6">
            <div class="flex-1 max-w-md">
                <label class="block text-sm font-medium mb-1 dark:text-gray-300">اختر الموظف</label>
                <p-select [options]="employees()" [(ngModel)]="selectedEmployeeId" optionLabel="fullName" optionValue="id" [filter]="true" filterBy="fullName" placeholder="ابحث عن الموظف..." styleClass="w-full"></p-select>
            </div>
            <button pButton label="عرض الجدول" icon="pi pi-search" (click)="fetchEmployeeRoster()" class="mt-6"></button>
        </div>

        <p-table [value]="employeeRoster()" *ngIf="employeeRoster().length > 0" [paginator]="true" [rows]="10" styleClass="p-datatable-sm p-datatable-gridlines">
            <ng-template pTemplate="header">
                <tr>
                    <th>التاريخ</th>
                    <th>اليوم</th>
                    <th>المناوبة الحالية</th>
                    <th>التوقيت</th>
                    <th>الحالة</th>
                    <th>تعديل</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-roster>
                <tr [ngClass]="{'bg-amber-50/50 dark:bg-amber-900/10': roster.isOffDay}">
                    <td>{{ roster.date | date:'yyyy-MM-dd' }}</td>
                    <td class="font-bold">{{ roster.dayName }}</td>
                    <td>{{ roster.shiftName }}</td>
                    <td>
                        <span *ngIf="!roster.isOffDay" class="text-xs">
                            {{ roster.startTime }} - {{ roster.endTime }}
                        </span>
                    </td>
                    <td>
                        <span class="px-2 py-1 rounded text-xs text-white" 
                              [ngClass]="{'bg-green-500': !roster.isOffDay, 'bg-amber-500': roster.isOffDay}">
                            {{ roster.isOffDay ? 'إجازة' : 'دوام' }}
                        </span>
                    </td>
                    <td>
                        <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm" (click)="openEditDialog(roster)"></button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
        
        <div *ngIf="employeeRoster().length === 0 && selectedEmployeeId()" class="text-center text-slate-400 py-8">
            لا توجد بيانات جدول لهذا الموظف.
        </div>
    </div>
</div>

<!-- Edit Day Dialog -->
<p-dialog [(visible)]="editDialogVisible" header="تعديل مناوبة يوم" [modal]="true" [style]="{width: '400px'}">
    <div class="p-4" *ngIf="editingDate">
        <div class="mb-4 text-center font-bold text-lg border-b pb-2">
            {{ editingDate | date:'fullDate' }}
        </div>
        
        <form [formGroup]="editDayForm">
            <div class="field-checkbox mb-4 flex items-center gap-2">
                <p-checkbox formControlName="isOffDay" [binary]="true" inputId="isOffDay"></p-checkbox>
                <label for="isOffDay" class="cursor-pointer select-none">يوم إجازة (Off Day)</label>
            </div>

            <div class="field" *ngIf="!editDayForm.get('isOffDay')?.value">
                <label class="block text-sm font-medium mb-1">المناوبة</label>
                <p-select [options]="shifts()" formControlName="shiftId" optionLabel="shiftNameAr" optionValue="shiftId" placeholder="اختر المناوبة" styleClass="w-full"></p-select>
            </div>
        </form>
    </div>
    <ng-template pTemplate="footer">
        <button pButton label="إلغاء" class="p-button-text" (click)="editDialogVisible = false"></button>
        <button pButton label="حفظ التغييرات" icon="pi pi-check" (click)="saveDayEdit()"></button>
    </ng-template>
</p-dialog>
