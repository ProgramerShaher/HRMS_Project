<div class="p-6 space-y-6 animate-in fade-in duration-500">
  <!-- Action Buttons -->
  <app-action-buttons
    [showBack]="true"
    [showRefresh]="true"
    backRoute="/payroll/loans/admin/all"
    (refresh)="loadPendingLoans()"
  ></app-action-buttons>

  <!-- Header -->
  <div class="glass-panel p-6 rounded-2xl">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">
          السلف المعلقة
        </h1>
        <p class="text-slate-500 dark:text-zinc-400 mt-1">
          السلف التي تحتاج إلى موافقة
        </p>
      </div>
      <div class="text-left">
        <p class="text-sm text-slate-500 dark:text-zinc-400">عدد السلف المعلقة</p>
        <h2 class="text-4xl font-bold text-amber-600 dark:text-amber-400">
          {{ pendingLoans().length }}
        </h2>
      </div>
    </div>
  </div>

  <!-- Pending Loans Table -->
  <div class="glass-panel rounded-2xl overflow-hidden">
    <p-table 
      [value]="pendingLoans()" 
      [loading]="loading()" 
      [paginator]="true" 
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>رقم السلفة</th>
          <th>الموظف</th>
          <th>المبلغ</th>
          <th>عدد الأقساط</th>
          <th>القسط الشهري</th>
          <th>تاريخ الطلب</th>
          <th class="text-center">الإجراءات</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-loan>
        <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors">
          <td>
            <span class="font-mono font-bold text-blue-600 dark:text-blue-400">
              #{{ loan.loanId }}
            </span>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white font-bold text-sm">
                {{ loan.employeeName?.charAt(0) || 'م' }}
              </div>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  {{ loan.employeeName || 'موظف #' + loan.employeeId }}
                </p>
                <p class="text-xs text-slate-500 dark:text-zinc-400">
                  ID: {{ loan.employeeId }}
                </p>
              </div>
            </div>
          </td>
          <td>
            <span class="font-bold text-lg text-slate-900 dark:text-white">
              {{ formatCurrency(loan.loanAmount) }}
            </span>
            <span class="text-sm text-slate-500"> ريال</span>
          </td>
          <td>
            <p-tag 
              [value]="loan.installmentCount + ' قسط'" 
              severity="info"
            ></p-tag>
          </td>
          <td>
            <span class="font-bold text-emerald-600 dark:text-emerald-400">
              {{ formatCurrency(calculateMonthlyInstallment(loan)) }}
            </span>
            <span class="text-sm text-slate-500"> ريال</span>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <i class="pi pi-calendar text-slate-400"></i>
              <span>{{ formatDate(loan.requestDate) }}</span>
            </div>
          </td>
          <td>
            <div class="flex items-center justify-center gap-2">
              <p-button
                icon="pi pi-eye"
                [rounded]="true"
                [text]="true"
                severity="info"
                (onClick)="viewDetails(loan)"
                pTooltip="عرض التفاصيل"
              ></p-button>
              <p-button
                icon="pi pi-check"
                [rounded]="true"
                severity="success"
                (onClick)="openApprovalDialog(loan)"
                pTooltip="موافقة/رفض"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-12">
            <div class="flex flex-col items-center gap-3">
              <i class="pi pi-check-circle text-6xl text-emerald-400"></i>
              <p class="text-lg font-semibold text-slate-700 dark:text-zinc-300">
                لا توجد سلف معلقة
              </p>
              <p class="text-sm text-slate-500 dark:text-zinc-400">
                جميع السلف تمت معالجتها
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Approval Dialog -->
<p-dialog 
  [(visible)]="showApprovalDialog" 
  [modal]="true" 
  [style]="{width: '550px'}"
  header="الموافقة على السلفة" 
  styleClass="rounded-2xl"
>
  @if (selectedLoan) {
    <div class="space-y-4">
      <!-- Loan Summary -->
      <div class="p-4 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-slate-600 dark:text-zinc-400 mb-1">رقم السلفة</p>
            <p class="font-bold text-lg text-blue-600 dark:text-blue-400">
              #{{ selectedLoan.loanId }}
            </p>
          </div>
          <div>
            <p class="text-xs text-slate-600 dark:text-zinc-400 mb-1">الموظف</p>
            <p class="font-semibold text-slate-900 dark:text-white">
              {{ selectedLoan.employeeName || 'موظف #' + selectedLoan.employeeId }}
            </p>
          </div>
          <div>
            <p class="text-xs text-slate-600 dark:text-zinc-400 mb-1">المبلغ الإجمالي</p>
            <p class="font-bold text-lg text-slate-900 dark:text-white">
              {{ formatCurrency(selectedLoan.loanAmount) }} ريال
            </p>
          </div>
          <div>
            <p class="text-xs text-slate-600 dark:text-zinc-400 mb-1">عدد الأقساط</p>
            <p class="font-bold text-lg text-slate-900 dark:text-white">
              {{ selectedLoan.installmentCount }} قسط
            </p>
          </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-blue-200 dark:border-blue-800">
          <p class="text-xs text-slate-600 dark:text-zinc-400 mb-1">القسط الشهري</p>
          <p class="font-bold text-2xl text-emerald-600 dark:text-emerald-400">
            {{ formatCurrency(calculateMonthlyInstallment(selectedLoan)) }} ريال
          </p>
        </div>
      </div>

      <!-- Notes -->
      <div>
        <label class="block text-sm font-medium text-slate-700 dark:text-zinc-300 mb-2">
          ملاحظات (اختياري)
        </label>
        <textarea 
          [(ngModel)]="approvalNotes" 
          rows="3" 
          class="w-full p-3 border border-slate-300 dark:border-zinc-600 rounded-xl focus:ring-2 focus:ring-blue-500 dark:bg-zinc-800 dark:text-white"
          placeholder="أضف ملاحظات حول الموافقة أو الرفض..."
        ></textarea>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-2 pt-4 border-t border-slate-200 dark:border-zinc-700">
        <p-button 
          label="إلغاء" 
          icon="pi pi-times" 
          styleClass="p-button-text p-button-secondary"
          (onClick)="showApprovalDialog.set(false)"
        ></p-button>
        <p-button 
          label="رفض" 
          icon="pi pi-ban" 
          severity="danger"
          styleClass="p-button-outlined"
          (onClick)="rejectLoan()"
        ></p-button>
        <p-button 
          label="موافقة" 
          icon="pi pi-check" 
          severity="success"
          (onClick)="approveLoan()"
        ></p-button>
      </div>
    </div>
  }
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
